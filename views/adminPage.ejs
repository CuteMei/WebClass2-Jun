<html>
    <head>
        <title>JHH Admin Page</title>
        <%- include('partials/header1.ejs') %>
        <!-- Flatpickr CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    </head>
    <body>
        <%- include('partials/navbar3.ejs') %>
        <div class="container"><br>
            <h2>New Booking</h2>
            <% if (message) { %>
                <p style="color: green;"><%- message %></p>
            <% } %>
            <form method="post" id="bookingForm">
                <input type="text" name="name" placeholder="Enter Name" required />
                <input type="tel" name="phone" placeholder="Enter Phone Number" required />
                <input type="text" name="date" id="dateInput" placeholder="Select Date" required readonly />
                <select name="time" id="timeSelect" required>
                    <option value="" disabled selected>--Select Time--</option>
                    <option value="09:30">09:30</option>
                    <option value="11:00">11:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:30">14:30</option>
                    <option value="16:00">16:00</option>
                </select>
                <button type="submit">Submit</button>
            </form>          
        </div>
    
        <!-- Flatpickr JS -->
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script>
            // Calculate min date: 48 hours from now
            const minDate = new Date();
            minDate.setHours(minDate.getHours() + 48);

            flatpickr('#dateInput', {
                minDate: minDate,
                disable: [
                    function(date) {
                        // Block Wednesday (3), Saturday (6), Sunday (0)
                        return [0, 3, 6].includes(date.getDay());
                    }
                ],
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates, dateStr) {
                    // When date changes, fetch available time slots
                    if (dateStr) {
                        fetchAvailableSlots(dateStr);
                    }
                }
            });

            async function fetchAvailableSlots(date) {
                try {
                    const response = await fetch(`/available-slots?date=${date}`);
                    const data = await response.json();
                    
                    const timeSelect = document.getElementById('timeSelect');
                    const allSlots = [
                        { value: '09:30', label: '09:30' },
                        { value: '11:00', label: '11:00' },
                        { value: '13:00', label: '13:00' },
                        { value: '14:30', label: '14:30' },
                        { value: '16:00', label: '16:00' }
                    ];

                    // Clear and rebuild options
                    timeSelect.innerHTML = '<option value="" disabled selected>--Select Time--</option>';
                    
                    allSlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.value;
                        option.textContent = slot.label;
                        
                        // Disable if already booked
                        if (data.bookedSlots.includes(slot.value)) {
                            option.disabled = true;
                            option.textContent += ' (Booked)';
                        }
                        
                        timeSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching slots:', error);
                }
            }
        </script>
    </body><br><br><br>
    <footer>
        <p>&copy; 2026 Jun Healthcare House. All rights reserved.</p>
    </footer>
</html>